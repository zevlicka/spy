<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kdo je Impostor? - SpyGame</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .chat-bubble {
            padding: 8px 12px;
            border-radius: 16px;
            margin-bottom: 6px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.95rem;
            line-height: 1.3;
        }
        .chat-self { background-color: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-other { background-color: #374151; color: #e5e7eb; align-self: flex-start; border-bottom-left-radius: 4px; }

        .emergency-active { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        #secretImage {
            min-height: 200px;
            background-color: #1f2937;
            display: block;
        }
    </style>
</head>
<body class="text-white flex flex-col h-[100dvh] overflow-hidden">

    <!-- HLAVN√ç KONTEJNER -->
    <div id="mainContainer" class="flex-1 flex flex-col max-w-md mx-auto w-full bg-gray-800 h-full relative shadow-2xl sm:border-x-4 border-gray-700">
        
        <!-- LOADING COVER -->
        <div id="loadingOverlay" class="absolute inset-0 bg-gray-900 z-[100] flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-400 font-bold tracking-widest text-sm">P≈òIPOJOV√ÅN√ç...</p>
        </div>

        <!-- VIEW CONTENT -->
        <div id="viewContent" class="flex-1 flex flex-col overflow-hidden relative"></div>
    </div>

    <!-- ≈†ABLONY -->
    
    <!-- 1. MENU -->
    <template id="tpl-menu">
        <div class="flex flex-col h-full bg-gray-900">
            <div class="p-6 pb-2 text-center shrink-0">
                <h1 class="text-5xl font-black text-red-600 tracking-tighter">SPYGAME</h1>
                <p class="text-gray-500 text-[10px] tracking-[0.4em] uppercase -mt-1 font-bold">Find The Impostor</p>
            </div>
            
            <div class="px-6 space-y-3 shrink-0">
                <div class="bg-gray-900 p-2 rounded-xl border border-gray-700 flex flex-col mb-1.5">
                    <label class="text-[10px] font-bold text-gray-500 ml-1 mb-1 uppercase">Z√°kladn√≠ p≈ôezd√≠vka (povinn√©)</label>
                    <select id="baseNameSelect" class="w-full bg-gray-800 text-white font-bold outline-none text-sm p-2 rounded-xl border border-gray-700">
                        <option value="" disabled selected>Vyber jm√©no...</option>
                        <option value="Alex">Alex</option>
                        <option value="Vojta">Vojta</option>
                        <option value="Martin">Martin</option>
                        <option value="Kuba Sl.">Kuba Sl.</option>
                        <option value="Kuba St.">Kuba St.</option>
                        <option value="Honza">Honza</option>
                        <option value="≈†tƒõp√°n">≈†tƒõp√°n</option>
                        <option value="Vl√°ƒèa">Vl√°ƒèa</option>
                        <option value="David">David</option>
                    </select>
                </div>

                <input type="text" id="customNameInput" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700 focus:border-red-500 outline-none text-center text-sm font-bold text-white placeholder-gray-600 transition-all" placeholder="Vlastn√≠ p≈ôezd√≠vka (voliteln√©)">
                
                <div class="bg-gray-900 p-2 rounded-xl border border-gray-700 flex flex-col mt-1">
                    <label class="text-[10px] font-bold text-gray-500 ml-1 mb-1 uppercase">Sada Karet</label>
                    <select id="cardSetSelect" class="w-full bg-transparent text-white font-bold outline-none text-sm p-1">
                        <option value="" disabled selected>Naƒç√≠t√°m...</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <button id="btnCreateGame" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-all">
                        VYTVO≈òIT
                    </button>
                    <div class="flex flex-col flex-1 gap-1">
                        <div class="flex gap-1 h-full">
                            <input type="text" id="gameCodeInput" placeholder="K√ìD" class="w-16 p-0 text-center rounded-l-xl bg-gray-800 border-y border-l border-gray-700 outline-none text-sm font-mono uppercase text-white">
                            <button id="btnJoinGame" class="flex-1 bg-gray-700 hover:bg-gray-600 rounded-r-xl font-bold text-sm border border-gray-700">
                                P≈òIPOJIT
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col px-6 pt-4 pb-2 min-h-0">
                <p class="text-[10px] font-bold text-gray-500 uppercase mb-2 ml-1">üè† Aktivn√≠ m√≠stnosti (Max 5)</p>
                <div id="activeLobbiesList" class="flex-1 overflow-y-auto space-y-2 pr-1 pb-2">
                    <div class="text-center text-gray-600 text-xs py-4 italic">Hled√°m hry...</div>
                </div>
            </div>

            <button id="btnAdminUpload" class="text-gray-800 text-[9px] py-1 text-center hover:text-gray-600">Admin Tools</button>
        </div>
    </template>

    <!-- 2. LOBBY -->
    <template id="tpl-lobby">
        <div class="flex flex-col h-full p-4 bg-gray-800">
            <div class="bg-gray-900 rounded-2xl p-4 text-center border border-gray-700 mb-4 shrink-0 shadow-lg">
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-1">K√≥d m√≠stnosti</p>
                <div id="displayGameCode" class="text-5xl font-mono font-black text-white tracking-widest select-all">????</div>
                <div id="selectedSetName" class="text-[10px] text-blue-400 font-bold uppercase mt-1 tracking-wide">...</div>
                <div class="mt-3 text-[10px] text-gray-400 font-bold uppercase tracking-wide">
                    ƒåas na tah: <span id="turnDurationLabel">--</span>
                </div>
            </div>

            <div class="flex justify-between items-end mb-2 px-2">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide">Hr√°ƒçi v lobby</h3>
                <span id="playerCountBadge" class="text-[10px] bg-gray-700 px-2 py-0.5 rounded text-white font-bold">0</span>
            </div>
            
            <ul id="playersList" class="bg-gray-900/50 rounded-2xl p-2 space-y-1.5 flex-grow overflow-y-auto border border-gray-700 shadow-inner"></ul>

            <div class="mt-4 shrink-0 space-y-3">
                <div id="hostSettings" class="hidden bg-gray-900/70 rounded-2xl border border-gray-700 p-3 space-y-2">
                    <div class="text-[10px] text-gray-500 font-bold uppercase tracking-wide text-left mb-1">
                        Nastaven√≠ hry (jen host)
                    </div>
                    <div class="flex flex-col gap-1 text-left">
                        <label class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Set karet</label>
                        <select id="lobbyCardSetSelect" class="w-full bg-gray-800 text-white text-sm font-bold rounded-xl px-2 py-1 border border-gray-700 outline-none"></select>
                    </div>
                    <div class="flex flex-col gap-1 text-left">
                        <label class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">D√©lka tahu (s)</label>
                        <input id="turnDurationInput" type="number" min="5" max="120" class="w-full bg-gray-800 text-white text-sm font-bold rounded-xl px-2 py-1 border border-gray-700 outline-none text-center">
                    </div>
                </div>

                <div id="hostControls" class="hidden">
                    <button id="btnStartGame" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-xl shadow-lg animate-pulse transition-all active:scale-95">
                        SPUSTIT HRU
                    </button>
                </div>
                <div id="waitingForHost" class="hidden text-center py-4 text-gray-500 font-bold text-xs animate-pulse">
                    ƒåEK√ÅME NA ZAKLADATELE...
                </div>
            </div>
        </div>
    </template>

    <!-- 3. GAME (REVEAL) -->
    <template id="tpl-game">
        <div class="flex flex-col h-full bg-gray-900 relative">
            
            <!-- A: OVERLAY - ODHALIT (Prvn√≠ krok) -->
            <div id="revealOverlay" class="absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-6">
                <button id="btnReveal" class="w-full max-w-sm aspect-[3/4] bg-gray-800 rounded-3xl border-4 border-dashed border-gray-700 flex flex-col items-center justify-center group active:scale-95 transition-all shadow-2xl">
                    <span class="text-6xl mb-4 group-hover:scale-110 transition-transform grayscale group-hover:grayscale-0">üïµÔ∏è</span>
                    <span class="text-xl font-bold text-gray-300 uppercase tracking-widest">Dotkni se<br>pro roli</span>
                </button>
            </div>

            <!-- B: OVERLAY - ƒåEK√ÅN√ç (Po potvrzen√≠) -->
            <div id="waitingOverlay" class="hidden absolute inset-0 z-40 bg-gray-900 flex flex-col items-center justify-center p-6 text-center">
                <div class="loader mb-6 border-gray-600 border-t-blue-500"></div>
                <h3 class="text-2xl font-bold text-white mb-2">Jsi p≈ôipraven</h3>
                <p class="text-gray-400 text-sm mb-4">ƒåek√°me na ostatn√≠...</p>
                <div id="readyCount" class="text-4xl font-mono font-bold text-blue-500 bg-gray-800 px-6 py-2 rounded-xl border border-gray-700">0/0</div>
            </div>

            <!-- C: OBSAH ROLE -->
            <div id="roleContainer" class="flex flex-col h-full w-full">
                
                <!-- 1. IMPOSTOR VIEW -->
                <div id="impostorView" class="hidden flex-col items-center justify-center h-full p-6 bg-gradient-to-b from-gray-900 to-red-900/40 relative text-center">
                    <h1 class="text-5xl font-black text-red-500 mb-2 tracking-tighter">IMPOSTOR</h1>
                    <div class="text-9xl my-8 filter drop-shadow-lg animate-bounce">ü§´</div>
                    <p class="text-xl font-bold text-white">Jsi ≈°pion!</p>
                    <p class="text-sm text-gray-400 mt-2">Nezn√°≈° tajn√© slovo.<br>Tva≈ô se nen√°padnƒõ.</p>
                    
                    <button id="impostorConfirmBtn" class="mt-auto w-full bg-red-600 hover:bg-red-500 py-4 rounded-xl font-bold text-white shadow-lg uppercase tracking-wider">
                        M√°m to, pokraƒçovat
                    </button>
                </div>

                <!-- 2. CREWMATE VIEW (Klasick√© rozlo≈æen√≠) -->
                <div id="crewmateView" class="hidden flex-col h-full w-full bg-gray-900 p-4">
                    <div class="text-center pb-2 shrink-0">
                        <h1 class="text-3xl font-black text-green-500 uppercase tracking-tighter">AGENT</h1>
                    </div>

                    <!-- Karta s obr√°zkem -->
                    <div class="flex-1 bg-black rounded-xl border border-gray-700 relative overflow-hidden flex flex-col mb-4">
                        <div class="bg-gray-800 p-3 border-b border-gray-700 text-center shrink-0">
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-0.5">Tajn√Ω C√≠l</p>
                            <p id="secretName" class="text-2xl font-black text-white leading-none truncate">...</p>
                        </div>
                        <div class="flex-1 relative w-full h-full p-2">
                             <img id="secretImage" src="" referrerpolicy="no-referrer" class="w-full h-full object-contain rounded-lg" alt="Tajn√Ω c√≠l" onerror="this.onerror=null; this.src='https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png';">
                        </div>
                    </div>

                    <button id="crewmateConfirmBtn" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-white shadow-lg uppercase tracking-wider shrink-0">
                        M√°m to, pokraƒçovat
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- 4. DISCUSSION -->
    <template id="tpl-discussion">
        <div class="flex flex-col h-full p-3 bg-gray-900">
            <!-- Info Bar -->
            <div class="flex justify-between items-center bg-gray-800 p-2.5 rounded-xl border border-gray-700 mb-2 shrink-0 shadow-md">
                <div>
                    <span class="text-[9px] text-gray-500 uppercase font-bold block">Kolo</span>
                    <span id="roundIndicator" class="text-lg font-bold text-white">1/3</span>
                </div>
                <div class="text-right flex flex-col items-end w-2/3">
                    <span class="text-[9px] text-gray-500 uppercase font-bold block">Na tahu</span>
                    <span id="currentTurnPlayer" class="text-yellow-400 font-bold truncate w-full text-right text-lg">...</span>
                </div>
                <div class="flex flex-col items-end ml-2">
                    <span class="text-[9px] text-gray-500 uppercase font-bold block">ƒåas</span>
                    <span id="turnTimer" class="text-lg font-bold text-blue-400">--</span>
                </div>
            </div>

            <!-- Chat -->
            <div id="chatContainer" class="flex-grow bg-gray-800/30 rounded-xl p-3 overflow-y-auto flex flex-col mb-2 border border-gray-700/50"></div>

            <!-- Emergency -->
            <button id="btnEmergency" class="w-full py-3 rounded-xl mb-2 flex items-center justify-center gap-3 font-bold bg-red-900/20 text-red-500 border border-red-900/50 shrink-0 transition-colors">
                <span class="text-xl">üö®</span>
                <div class="flex flex-col items-start leading-none">
                    <span class="text-xs uppercase font-black">Emergency Meeting</span>
                    <span id="emergencyCount" class="text-[9px] font-normal opacity-70">0/0</span>
                </div>
            </button>

            <!-- Input -->
            <div class="shrink-0 relative">
                <div id="notMyTurnMsg" class="absolute inset-0 bg-gray-800/95 rounded-xl flex items-center justify-center text-gray-500 text-xs font-bold border border-gray-700 border-dashed z-10 backdrop-blur-sm">
                    ƒåekej na sv≈Øj tah...
                </div>
                <form id="chatForm" class="flex gap-2 h-[56px]">
                    <input type="text" id="chatInput" class="flex-1 p-3 rounded-xl bg-gray-700 border border-gray-600 text-white font-bold outline-none focus:border-blue-500 placeholder-gray-500" placeholder="Max 3 slova...">
                    <button type="submit" class="w-[56px] bg-blue-600 rounded-xl font-bold text-xl flex items-center justify-center hover:bg-blue-500 text-white shadow-lg">‚û§</button>
                </form>
                <p id="wordCountError" class="hidden absolute -top-8 left-0 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg">‚ö†Ô∏è Max 3 slova!</p>
            </div>
        </div>
    </template>

    <!-- 5. VOTING -->
    <template id="tpl-voting">
        <div class="flex flex-col h-full p-4 pt-8 bg-gray-900">
            <h2 class="text-4xl font-black text-red-600 uppercase tracking-tighter text-center mb-1 shrink-0 drop-shadow-lg">KDO JE SPY?</h2>
            <p class="text-center text-gray-400 text-xs mb-6 shrink-0 uppercase tracking-wider">Oznaƒç podez≈ôel√©ho</p>
            
            <div id="votingList" class="flex-grow overflow-y-auto space-y-3 pr-1 pb-4"></div>
            
            <div id="voteStatus" class="mt-2 text-center text-gray-600 font-mono text-[10px] shrink-0 uppercase">ƒåek√°n√≠ na hlasy...</div>
        </div>
    </template>

    <!-- 6. RESULTS -->
    <template id="tpl-results">
        <div class="flex flex-col h-full justify-center items-center p-6 bg-gray-900">
            <h1 id="winTitle" class="text-5xl font-black mb-8 uppercase tracking-tighter text-center drop-shadow-2xl">???</h1>
            
            <div class="bg-gray-800 w-full rounded-3xl border border-gray-700 overflow-hidden shadow-2xl mb-8">
                <div class="p-6 text-center border-b border-gray-700 bg-gray-800/50">
                    <p class="text-gray-500 uppercase text-[10px] font-bold tracking-widest mb-3">Impostor byl</p>
                    <div class="flex flex-col items-center gap-2">
                        <div class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center text-4xl shadow-lg border-4 border-gray-700">ü§´</div>
                        <span id="revealImpostorName" class="text-3xl font-black text-white"></span>
                    </div>
                </div>

                <div class="p-6 text-center bg-green-900/10">
                    <p class="text-gray-500 uppercase text-[10px] font-bold tracking-widest mb-2">Tajn√© slovo</p>
                    <p id="revealSecretWord" class="text-3xl font-black text-green-400 tracking-wide leading-tight"></p>
                </div>
            </div>

            <!-- Host Actions -->
            <div id="hostResultControls" class="w-full space-y-3 hidden">
                <button id="btnPlayAgain" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-white shadow-[0_0_20px_rgba(34,197,94,0.4)] border border-green-500 active:scale-95 transition-all text-lg uppercase tracking-tight">
                    üîÑ Hr√°t znovu (Reset)
                </button>
                <button id="btnExitGame" class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-xl font-bold text-gray-300 text-sm">
                    Ukonƒçit hru
                </button>
            </div>
            
            <!-- Player Waiting -->
            <div id="playerResultWaiting" class="text-center space-y-4">
                <div class="loader mx-auto border-gray-600 border-t-green-500"></div>
                <p class="text-gray-400 font-bold text-sm uppercase">ƒåek√°n√≠ na hostitele...</p>
                <button id="btnPlayerExit" class="text-gray-600 underline text-xs mt-4">Odej√≠t do menu</button>
            </div>

        </div>
    </template>

    <!-- LOGIKA APLIKACE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, arrayUnion, getDoc, getDocs, addDoc, query, where, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/11.6

                // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyArCoQVExlvIhzU6Hc8ffiwbNL55VWHi34",
            authDomain: "spygame-87b8b.firebaseapp.com",
            projectId: "spygame-87b8b",
            storageBucket: "spygame-87b8b.firebasestorage.app",
            messagingSenderId: "151689614342",
            appId: "1:151689614342:web:d561337f3083efaf0e9f87",
            measurementId: "G-ZWD05TCV8Q"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'spygame-87b8b';

        let currentUser = null;
        let currentGameId = null;
        let unsubscribeGame = null;
        let unsubscribeLobbyList = null;
        const SILHOUETTE_URL = "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png";

        const container = document.getElementById('viewContent');
        const overlay = document.getElementById('loadingOverlay');

        // GLOBAL STATE HELPERS
        let latestGameData = null;
        let latestDiscussionData = null;
        let discussionInterval = null;

        function renderView(templateId, callback) {
            // Clear discussion timer when leaving discussion view
            if (templateId !== 'tpl-discussion' && discussionInterval) {
                clearInterval(discussionInterval);
                discussionInterval = null;
                latestDiscussionData = null;
            }
            container.innerHTML = '';
            const tpl = document.getElementById(templateId);
            const clone = tpl.content.cloneNode(true);
            container.appendChild(clone);
            if (callback) callback();
        }

        function showLoading(show) { overlay.classList.toggle('hidden', !show); }

        // --- AUTH ---
        showLoading(true);
        signInAnonymously(auth).catch(e => console.error(e));
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                renderMenu();
                showLoading(false);
            }
        });

        // --- 1. MENU ---
        function renderMenu() {
            renderView('tpl-menu', () => {
                const baseNameSel = document.getElementById('baseNameSelect');
                const customNameInp = document.getElementById('customNameInput');
                const setSel = document.getElementById('cardSetSelect');
                const lobbyList = document.getElementById('activeLobbiesList');

                function buildPlayerName() {
                    const base = baseNameSel.value;
                    const custom = customNameInp.value.trim();
                    if (!base) {
                        alert("Vyber si z√°kladn√≠ p≈ôezd√≠vku.");
                        return null;
                    }
                    return custom ? `${custom} (${base})` : base;
                }

                // Load Sets
                getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'cardSets')).then(snap => {
                    setSel.innerHTML = '';
                    if (snap.empty) setSel.innerHTML = '<option disabled>≈Ω√°dn√© sety</option>';
                    else {
                        snap.forEach(d => {
                            const opt = document.createElement('option');
                            opt.value = d.id;
                            opt.textContent = d.data().title;
                            setSel.appendChild(opt);
                        });
                        setSel.selectedIndex = 0;
                    }
                });

                // LIVE LOBBY LISTENER
                if(unsubscribeLobbyList) unsubscribeLobbyList();
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'games'));
                
                unsubscribeLobbyList = onSnapshot(q, (snap) => {
                    lobbyList.innerHTML = '';
                    const lobbies = [];
                    snap.forEach(doc => {
                        const d = doc.data();
                        // Zobraz v≈°echny hry kromƒõ tƒõch, kter√© u≈æ skonƒçily (RESULTS m≈Ø≈æe host zru≈°it)
                        if (d.status !== "RESULTS") {
                            lobbies.push({ id: doc.id, ...d });
                        }
                    });

                    if(lobbies.length === 0) {
                        lobbyList.innerHTML = '<div class="text-center text-gray-700 text-xs py-4">≈Ω√°dn√© aktivn√≠ hry</div>';
                    } else {
                        lobbies.forEach(d => {
                            const code = d.id;
                            const players = d.players ? d.players.length : 0;
                            const hostName = d.players && d.players.length > 0 ? d.players[0].name : "Nezn√°m√Ω";
                            const statusText = d.status === "LOBBY" ? "Lobby" : (d.status === "REVEAL" ? "Rozd√°v√°n√≠ rol√≠" : (d.status === "DISCUSSION" ? "Diskuze" : (d.status === "VOTING" ? "Hlasov√°n√≠" : d.status)));
                            
                            const item = document.createElement('div');
                            item.className = "bg-gray-800 p-3 rounded-xl border border-gray-700 flex justify-between items-center";
                            item.innerHTML = `
                                <div>
                                    <div class="font-bold text-sm text-white">${code} <span class="text-gray-500 font-normal">(${hostName})</span></div>
                                    <div class="text-[10px] text-gray-500 uppercase">${d.cardSetName || "Nezn√°m√Ω set"} ‚Ä¢ ${players} hr√°ƒç≈Ø ‚Ä¢ ${statusText}</div>
                                </div>
                                <button class="bg-blue-600 text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-blue-500 text-white">P≈òIPOJIT</button>
                            `;
                            item.querySelector('button').onclick = () => {
                                document.getElementById('gameCodeInput').value = code;
                                document.getElementById('btnJoinGame').click();
                            };
                            lobbyList.appendChild(item);
                        });
                    }
                });

                // Create Logic
                document.getElementById('btnCreateGame').onclick = async () => {
                    const name = buildPlayerName();
                    const setId = setSel.value;
                    if(!name || !setId) return alert("Vypl≈à jm√©no a vyber karty!");
                    showLoading(true);
                    if(unsubscribeLobbyList) unsubscribeLobbyList();
                    
                    // GARBAGE COLLECTOR
                    const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                    const allGamesSnap = await getDocs(gamesRef);
                    let allGames = [];
                    allGamesSnap.forEach(docSnap => allGames.push({id: docSnap.id, ...docSnap.data()}));
                    allGames.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

                    // Smazat v≈°echny star√© hry se stejnou p≈ôezd√≠vkou zakladatele
                    const sameNameGames = allGames.filter(g => Array.isArray(g.players) && g.players.length > 0 && g.players[0].name === name);
                    for (const g of sameNameGames) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', g.id));
                    }
                    
                    // Ponechat max 5 nejnovƒõj≈°√≠ch her v syst√©mu (glob√°ln√≠ limit)
                    if(allGames.length >= 5) {
                        const toDelete = allGames.slice(4);
                        for(const g of toDelete) {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', g.id));
                        }
                    }

                    const code = Math.random().toString(36).substr(2,4).toUpperCase();
                    const setName = setSel.options[setSel.selectedIndex].text;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', code), {
                        hostId: currentUser.uid,
                        status: 'LOBBY',
                        cardSetId: setId,
                        cardSetName: setName,
                        createdAt: new Date().toISOString(),
                        players: [{ uid: currentUser.uid, name: name, isHost: true }],
                        readyPlayers: [],
                        turnOrder: [],
                        chatMessages: [],
                        currentTurnIndex: 0,
                        votes: {},
                        emergencyVotes: [],
                        usedItems: [],
                        turnDuration: 30
                    });
                    joinGame(code);
                };

                // Join Logic
                document.getElementById('btnJoinGame').onclick = async () => {
                    const name = buildPlayerName();
                    const code = document.getElementById('gameCodeInput').value.trim().toUpperCase();
                    if(!name || code.length !== 4) return alert("Chyba √∫daj≈Ø!");
                    showLoading(true);
                    if(unsubscribeLobbyList) unsubscribeLobbyList();
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', code);
                    const snap = await getDoc(ref);
                    if(!snap.exists()) { showLoading(false); return alert("Hra neexistuje"); }
                    const d = snap.data();
                    if(!d.players.find(p => p.uid === currentUser.uid)) {
                        // Pokud se p≈ôipojuji do rozbƒõhl√© hry (mimo LOBBY), budu spectator do p≈ô√≠≈°t√≠ hry
                        const isSpectator = d.status !== 'LOBBY';
                        await updateDoc(ref, { players: arrayUnion({ uid: currentUser.uid, name: name, isHost: false, isSpectator }) });
                    }
                    joinGame(code);
                };
                
                document.getElementById('btnAdminUpload').onclick = async () => {
                    if(!confirm("Nahr√°t default?")) return;
                    const items = ["Martin","Kuba","Honz√≠k","Vojta"].map(n=>({name:n,image:SILHOUETTE_URL}));
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'cardSets'), {title:"Test Jm√©na", items});
                    alert("Hotovo"); location.reload();
                };
            });
        }

        // --- GAME JOIN & LOOP ---
        function joinGame(gameId) {
            currentGameId = gameId;
            if(unsubscribeGame) unsubscribeGame();
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);

            unsubscribeGame = onSnapshot(ref, (snap) => {
                if(!snap.exists()) { location.reload(); return; }
                const data = snap.data();
                latestGameData = { ...data };
                showLoading(false);

                const currentView = container.getAttribute('data-view');
                if (data.status !== currentView) {
                    container.setAttribute('data-view', data.status);
                    switch(data.status) {
                        case 'LOBBY': renderLobby(data); break;
                        case 'REVEAL': renderReveal(data); break;
                        case 'DISCUSSION': renderDiscussion(data); break;
                        case 'VOTING': renderVoting(data); break;
                        case 'RESULTS': renderResults(data); break;
                    }
                } else {
                    updateCurrentView(data);
                }
            });
        }

        // --- RENDERERS ---
        function renderLobby(data) { 
            renderView('tpl-lobby', async () => {
                // Init lobby card set select & turn duration input
                const setSelect = document.getElementById('lobbyCardSetSelect');
                const turnInput = document.getElementById('turnDurationInput');
                const turnLabel = document.getElementById('turnDurationLabel');

                try {
                    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'cardSets'));
                    setSelect.innerHTML = '';
                    snap.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.textContent = d.data().title;
                        setSelect.appendChild(opt);
                    });
                } catch (e) {
                    console.error('Card sets load error in lobby:', e);
                }

                // Handlers will be wired in updateLobby where we know if we are host
                updateLobby(data);
            }); 
        }

        function updateLobby(data) {
            document.getElementById('displayGameCode').textContent = currentGameId;
            document.getElementById('playerCountBadge').textContent = data.players.length;
            document.getElementById('selectedSetName').textContent = data.cardSetName || "";
            const list = document.getElementById('playersList');
            list.innerHTML = '';
            data.players.forEach(p => {
                const isMe = p.uid === currentUser.uid;
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 rounded-xl border ${isMe ? 'bg-gray-800 border-blue-500' : 'bg-gray-800/50 border-gray-700'}`;
                li.innerHTML = `<span class="font-bold text-sm text-white">${p.name}</span>${p.isHost ? '<span class="text-[9px] bg-yellow-600 px-1.5 py-0.5 rounded text-white font-bold">HOST</span>' : ''}`;
                list.appendChild(li);
            });
            const amHost = data.hostId === currentUser.uid;
            document.getElementById('hostControls').classList.toggle('hidden', !amHost);
            document.getElementById('waitingForHost').classList.toggle('hidden', amHost);

            // Turn duration & card set controls
            const hostSettings = document.getElementById('hostSettings');
            const turnInput = document.getElementById('turnDurationInput');
            const turnLabel = document.getElementById('turnDurationLabel');
            const setSelect = document.getElementById('lobbyCardSetSelect');

            const effectiveTurnDuration = data.turnDuration || 30;
            if (turnLabel) turnLabel.textContent = `${effectiveTurnDuration}s`;

            if (hostSettings) hostSettings.classList.toggle('hidden', !amHost);

            if (turnInput && !turnInput.dataset.bound) {
                turnInput.dataset.bound = "1";
                turnInput.addEventListener('change', async () => {
                    const v = parseInt(turnInput.value, 10);
                    if (isNaN(v) || v <= 0) return;
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), {
                            turnDuration: v
                        });
                    } catch (e) {
                        console.error('Turn duration update error:', e);
                    }
                });
            }
            if (turnInput && !isNaN(effectiveTurnDuration)) {
                turnInput.value = effectiveTurnDuration;
            }

            if (setSelect && !setSelect.dataset.bound) {
                setSelect.dataset.bound = "1";
                setSelect.addEventListener('change', async () => {
                    const setId = setSelect.value;
                    const setName = setSelect.options[setSelect.selectedIndex]?.text || '';
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), {
                            cardSetId: setId,
                            cardSetName: setName,
                            usedItems: [] // reset used items when changing set
                        });
                    } catch (e) {
                        console.error('Card set change error:', e);
                    }
                });
            }
            if (setSelect && data.cardSetId) {
                setSelect.value = data.cardSetId;
            }

            if (amHost) {
                document.getElementById('btnStartGame').onclick = async () => {
                    if (data.players.length < 2) return alert("Min 2 hr√°ƒçi");
                    showLoading(true);
                    try {
                        const setRef = doc(db, 'artifacts', appId, 'public', 'data', 'cardSets', data.cardSetId);
                        const sSnap = await getDoc(setRef);
                        const allItems = sSnap.exists() ? sSnap.data().items : [{name:"Err", image:SILHOUETTE_URL}];
                        
                        // Get used items from current game data
                        const usedItems = data.usedItems || [];
                        const usedItemNames = new Set(usedItems.map(item => item.name));
                        
                        // Filter out already used items
                        const availableItems = allItems.filter(item => !usedItemNames.has(item.name));
                        
                        // If all items have been used, reset and use all items again
                        const itemsToChooseFrom = availableItems.length > 0 ? availableItems : allItems;
                        const item = itemsToChooseFrom[Math.floor(Math.random() * itemsToChooseFrom.length)];
                        
                        // Add selected item to usedItems (or reset if we ran out)
                        const newUsedItems = availableItems.length > 0 
                            ? [...usedItems, item] 
                            : [item];
                        
                        // impostora vol√≠me jen z hr√°ƒç≈Ø, kte≈ô√≠ nejsou spectator
                        const activePlayers = data.players.filter(p => !p.isSpectator);
                        const pool = activePlayers.length > 0 ? activePlayers : data.players;
                        const imp = pool[Math.floor(Math.random() * pool.length)];
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), {
                            status: 'REVEAL',
                            secretItem: item,
                            impostorUid: imp.uid,
                            readyPlayers: [],
                            votes: {},
                            emergencyVotes: [],
                            usedItems: newUsedItems
                        });
                    } catch(e) { console.error(e); showLoading(false); }
                };
            }
        }

        function renderReveal(data) { renderView('tpl-game', () => updateReveal(data)); }
        function updateReveal(data) {
            const isImp = data.impostorUid === currentUser.uid;
            const isReady = data.readyPlayers && data.readyPlayers.includes(currentUser.uid);
            
            const overlayReveal = document.getElementById('revealOverlay');
            const overlayWait = document.getElementById('waitingOverlay');
            const impView = document.getElementById('impostorView');
            const crewView = document.getElementById('crewmateView');

            // If user has already revealed and is crewmate, ensure image is set when view updates
            if (!isImp && overlayReveal && overlayReveal.classList.contains('hidden') && data.secretItem) {
                const imgEl = document.getElementById('secretImage');
                if (imgEl && data.secretItem.image && imgEl.src !== data.secretItem.image) {
                    imgEl.src = data.secretItem.image;
                    imgEl.onerror = function() {
                        this.onerror = null;
                        this.src = SILHOUETTE_URL;
                    };
                }
            }

            if (isReady) {
                overlayReveal.classList.add('hidden');
                overlayWait.classList.remove('hidden');
                document.getElementById('readyCount').textContent = `${data.readyPlayers.length}/${data.players.length}`;
            } else {
                overlayWait.classList.add('hidden');
            }

            // Reveal Button
                document.getElementById('btnReveal').onclick = () => {
                overlayReveal.classList.add('hidden');
                if (isImp) {
                    impView.classList.remove('hidden');
                    crewView.classList.add('hidden');
                } else {
                    impView.classList.add('hidden');
                    crewView.classList.remove('hidden');
                    document.getElementById('secretName').textContent = data.secretItem.name;
                    const imgEl = document.getElementById('secretImage');
                    if (data.secretItem && data.secretItem.image) {
                        imgEl.src = data.secretItem.image;
                        imgEl.onerror = function() {
                            this.onerror = null;
                            this.src = SILHOUETTE_URL;
                        };
                    } else {
                        imgEl.src = SILHOUETTE_URL;
                    }
                }
            };

            const confirmAction = async () => {
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), {
                    readyPlayers: arrayUnion(currentUser.uid)
                });
            };

            document.getElementById('crewmateConfirmBtn').onclick = confirmAction;
            document.getElementById('impostorConfirmBtn').onclick = confirmAction;

            if (data.hostId === currentUser.uid && data.readyPlayers && data.readyPlayers.length === data.players.length) {
                const activePlayers = data.players.filter(p => !p.isSpectator);
                const order = activePlayers.map(p => p.uid).sort(() => Math.random() - 0.5);
                const duration = data.turnDuration || 30;
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), {
                    status: 'DISCUSSION',
                    turnOrder: order,
                    currentTurnIndex: 0,
                    turnExpiresAt: Date.now() + duration * 1000
                });
            }
        }

        // Helper function to check and transition to voting if emergency threshold is met
        async function checkEmergencyThreshold(gameData) {
            if (!gameData || gameData.status !== 'DISCUSSION') return false;
            
            const activePlayers = (gameData.players || []).filter(p => !p.isSpectator);
            const total = activePlayers.length || (gameData.players ? gameData.players.length : 0);
            const eCount = gameData.emergencyVotes ? gameData.emergencyVotes.length : 0;
            const req = total > 0 ? Math.ceil(total * 0.6) : 0;
            const turn = gameData.currentTurnIndex || 0;
            
            if (req > 0 && (eCount >= req || turn >= total * 3)) {
                // Get fresh data to prevent race conditions
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId);
                try {
                    const freshSnap = await getDoc(gameRef);
                    if (freshSnap.exists()) {
                        const freshData = freshSnap.data();
                        // Only transition if still in DISCUSSION and threshold still met
                        if (freshData.status === 'DISCUSSION') {
                            const freshActive = (freshData.players || []).filter(p => !p.isSpectator);
                            const freshTotal = freshActive.length || (freshData.players ? freshData.players.length : 0);
                            const freshCount = freshData.emergencyVotes ? freshData.emergencyVotes.length : 0;
                            const freshReq = freshTotal > 0 ? Math.ceil(freshTotal * 0.6) : 0;
                            const freshTurn = freshData.currentTurnIndex || 0;
                            if (freshReq > 0 && (freshCount >= freshReq || freshTurn >= freshTotal * 3)) {
                                await updateDoc(gameRef, { status: 'VOTING' });
                                return true;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Emergency threshold check error:', err);
                }
            }
            return false;
        }

        // Helper: auto skip turn when timer expires (host-side safety)
        async function checkTurnTimeout(gameData) {
            if (!gameData || gameData.status !== 'DISCUSSION' || !gameData.turnExpiresAt) return false;
            const now = Date.now();
            if (now < gameData.turnExpiresAt) return false;

            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId);
            try {
                const freshSnap = await getDoc(gameRef);
                if (!freshSnap.exists()) return false;
                const freshData = freshSnap.data();
                if (freshData.status !== 'DISCUSSION' || !freshData.turnExpiresAt) return false;

                const now2 = Date.now();
                if (now2 < freshData.turnExpiresAt) return false;

                // Skip only if we are still on the same turn index (no one poslal zpr√°vu)
                if (freshData.currentTurnIndex === gameData.currentTurnIndex) {
                    const duration = freshData.turnDuration || 30;
                    await updateDoc(gameRef, {
                        currentTurnIndex: increment(1),
                        turnExpiresAt: Date.now() + duration * 1000
                    });
                    return true;
                }
            } catch (err) {
                console.error('Turn timeout check error:', err);
            }
            return false;
        }

        function renderDiscussion(data) { 
            renderView('tpl-discussion', () => {
                latestDiscussionData = data;

                const chatForm = document.getElementById('chatForm');
                chatForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const inp = document.getElementById('chatInput');
                    const val = inp.value.trim();
                    if(val.split(/\s+/).filter(x=>x).length > 3 || !val) {
                        const err = document.getElementById('wordCountError'); 
                        err.classList.remove('hidden'); 
                        setTimeout(()=>err.classList.add('hidden'),2000); 
                        return;
                    }

                    // Povolit odesl√°n√≠ jen pokud jsem na tahu a nejsem spectator
                    const gd = latestDiscussionData;
                    if (!gd) return;
                    const me = gd.players.find(p => p.uid === currentUser.uid);
                    if (me && me.isSpectator) {
                        // spectator v tomto kole jen sleduje
                        return;
                    }
                    const activePlayers = gd.players.filter(p => !p.isSpectator);
                    const activeTotal = activePlayers.length || 1;
                    const turn = gd.currentTurnIndex || 0;
                    const uidTurn = (gd.turnOrder && gd.turnOrder.length > 0)
                        ? gd.turnOrder[turn % gd.turnOrder.length]
                        : (activePlayers[turn % activeTotal]?.uid || null);
                    const isMyTurn = uidTurn === currentUser.uid;
                    if (!isMyTurn) {
                        // nech√°me text v inputu, jen neode≈°leme
                        return;
                    }

                    inp.value = '';
                    const duration = (gd.turnDuration || 30);
                    // USE INCREMENT FOR TURN SWITCHING + nastavit nov√Ω ƒças
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), {
                        chatMessages: arrayUnion({s: currentUser.uid, t: val}), 
                        currentTurnIndex: increment(1),
                        turnExpiresAt: Date.now() + duration * 1000
                    });
                };

                document.getElementById('btnEmergency').onclick = async () => {
                    const gd = latestDiscussionData;
                    if (!gd) return;
                    const me = gd.players.find(p => p.uid === currentUser.uid);
                    if (me && me.isSpectator) {
                        // spectator nem≈Ø≈æe hlasovat pro emergency
                        return;
                    }
                    const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId);
                    await updateDoc(gameRef, { emergencyVotes: arrayUnion(currentUser.uid) });
                    
                    // Immediately check threshold after voting (any player can trigger if host is slow)
                    const gameSnap = await getDoc(gameRef);
                    if (gameSnap.exists()) {
                        await checkEmergencyThreshold(gameSnap.data());
                    }
                };

                // Timer UI
                const timerEl = document.getElementById('turnTimer');
                if (discussionInterval) {
                    clearInterval(discussionInterval);
                    discussionInterval = null;
                }
                discussionInterval = setInterval(() => {
                    if (!latestDiscussionData || !latestDiscussionData.turnExpiresAt) {
                        if (timerEl) timerEl.textContent = '--';
                        return;
                    }
                    const now = Date.now();
                    const msLeft = latestDiscussionData.turnExpiresAt - now;
                    const secLeft = Math.max(0, Math.ceil(msLeft / 1000));
                    if (timerEl) timerEl.textContent = `${secLeft}s`;

                    // Host ≈ôe≈°√≠ auto-skip, aby se to nespou≈°tƒõlo z ka≈æd√©ho klienta
                    if (latestDiscussionData.hostId === currentUser.uid && msLeft <= 0) {
                        checkTurnTimeout(latestDiscussionData).catch(err => console.error(err));
                    }
                }, 1000);

                updateDiscussion(data);
            });
        }

        function updateDiscussion(data) {
            latestDiscussionData = data;

            const me = data.players.find(p => p.uid === currentUser.uid);
            const isSpectator = !!(me && me.isSpectator && data.status !== 'LOBBY');

            const activePlayers = data.players.filter(p => !p.isSpectator);
            const activeTotal = activePlayers.length || 1;
            const turn = data.currentTurnIndex || 0;
            const round = Math.floor(turn / activeTotal) + 1;
            document.getElementById('roundIndicator').textContent = `${Math.min(round, 3)}/3`;
            
            const uidTurn = data.turnOrder && data.turnOrder.length > 0
                ? data.turnOrder[turn % data.turnOrder.length]
                : (activePlayers[turn % activeTotal]?.uid || null);
            const pTurn = data.players.find(p => p.uid === uidTurn);
            document.getElementById('currentTurnPlayer').textContent = pTurn?.name || "...";

            const box = document.getElementById('chatContainer');
            box.innerHTML = '';
            (data.chatMessages || []).forEach(m => {
                const isMe = m.s === currentUser.uid;
                const name = data.players.find(p => p.uid === m.s)?.name || "?";
                const d = document.createElement('div');
                d.className = `chat-bubble flex flex-col ${isMe ? 'chat-self' : 'chat-other'}`;
                d.innerHTML = `<span class="text-[9px] opacity-70 mb-0.5 uppercase font-bold">${name}</span><span class="font-bold">${m.t}</span>`;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;

            const isMyTurn = !isSpectator && uidTurn === currentUser.uid;
            // Overlay u≈æ neblokuje input ‚Äì nech√°me ho v≈ædy skryt√Ω, odesl√°n√≠ hl√≠d√° logika v JS
            const notMsg = document.getElementById('notMyTurnMsg');
            if (notMsg) notMsg.classList.add('hidden');

            const eCount = (data.emergencyVotes || []).filter(uid => {
                const p = data.players.find(pl => pl.uid === uid);
                return p && !p.isSpectator;
            }).length;
            const req = Math.ceil(activeTotal * 0.6);
            document.getElementById('emergencyCount').textContent = `${eCount}/${req}`;
            const btnEm = document.getElementById('btnEmergency');
            if (data.emergencyVotes && data.emergencyVotes.includes(currentUser.uid) && !isSpectator) {
                btnEm.classList.add('bg-red-600', 'text-white', 'border-transparent');
                btnEm.classList.remove('emergency-active', 'text-red-500', 'bg-red-900/20');
                btnEm.innerHTML = '<span class="font-bold text-sm">ZASTAVENO</span>';
            } else if (!isSpectator) {
                btnEm.classList.add('emergency-active');
            } else {
                // spectator ‚Äì jen sleduje, nem√° tlaƒç√≠tko aktivn√≠
                btnEm.classList.remove('emergency-active');
                btnEm.disabled = true;
                btnEm.classList.add('opacity-60');
            }

            // Check if emergency meeting threshold is met (any client can trigger, but only if threshold is met)
            // This ensures it works even if host's client is slow or inactive
            checkEmergencyThreshold(data).catch(err => console.error('Emergency check error:', err));
        }

        function renderVoting(data) { renderView('tpl-voting', () => updateVoting(data)); }
        function updateVoting(data) {
            const list = document.getElementById('votingList');
            list.innerHTML = '';

            const me = data.players.find(p => p.uid === currentUser.uid);
            const isSpectator = !!(me && me.isSpectator && data.status !== 'LOBBY');

            const myVote = data.votes ? data.votes[currentUser.uid] : null;
            document.getElementById('voteStatus').textContent = myVote ? "Hlas ulo≈æen." : (isSpectator ? "V tomto kole jen sleduje≈°." : "Oznaƒç podez≈ôel√©ho.");
            
            const voteEntries = data.votes ? Object.entries(data.votes) : [];

            // Hlasovat lze jen o aktivn√≠ch hr√°ƒç√≠ch (bez spectator≈Ø)
            const activePlayers = data.players.filter(p => !p.isSpectator);

            activePlayers.forEach(p => {
                if (p.uid === currentUser.uid) return;
                const btn = document.createElement('button');
                const theirVoters = voteEntries
                    .filter(([voter, target]) => target === p.uid)
                    .map(([voter]) => data.players.find(pl => pl.uid === voter)?.name || '?');

                btn.className = `w-full p-4 rounded-xl font-bold border-2 flex flex-col items-start transition-all ${myVote === p.uid ? 'bg-red-600 border-red-500 text-white' : 'bg-gray-800 border-gray-600 text-gray-300'}`;
                btn.innerHTML = `
                    <div class="w-full flex justify-between items-center">
                        <span>${p.name}</span>
                        <span>${myVote === p.uid ? 'üëà' : ''}</span>
                    </div>
                    <div class="text-[10px] text-gray-300 uppercase mt-1">
                        ${theirVoters.length} hlas≈Ø${theirVoters.length ? ': ' + theirVoters.join(', ') : ''}
                    </div>
                `;
                // spectator v tomto kole nem≈Ø≈æe hlasovat
                btn.disabled = isSpectator || !!myVote;
                if (!isSpectator) {
                    btn.onclick = async () => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), { [`votes.${currentUser.uid}`]: p.uid });
                }
                list.appendChild(btn);
            });

            // Poƒçet hlas≈Ø poƒç√≠t√°me jen od hr√°ƒç≈Ø, kte≈ô√≠ nejsou spectator
            if (data.hostId === currentUser.uid && data.votes && Object.keys(data.votes).length === activePlayers.length) {
                const counts = {};
                Object.values(data.votes).forEach(u => counts[u] = (counts[u]||0)+1);
                let max = 0, susp = null;
                for(const [u,c] of Object.entries(counts)) { if(c > max) { max=c; susp=u; } else if(c===max) susp=null; }
                const win = (susp === data.impostorUid) ? 'CREWMATES' : 'IMPOSTOR';
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), { status: 'RESULTS', winner: win });
            }
        }

        function renderResults(data) {
            renderView('tpl-results', () => {
                const impName = data.players.find(p => p.uid === data.impostorUid)?.name;
                document.getElementById('revealImpostorName').textContent = impName;
                document.getElementById('revealSecretWord').textContent = data.secretItem.name;
                const title = document.getElementById('winTitle');
                if (data.winner === 'CREWMATES') {
                    title.textContent = "AGENTI VYHR√ÅLI";
                    title.className = "text-5xl font-black mb-6 uppercase tracking-tighter text-center text-green-500 drop-shadow-lg";
                } else {
                    title.textContent = "IMPOSTOR VYHR√ÅL";
                    title.className = "text-5xl font-black mb-6 uppercase tracking-tighter text-center text-red-500 drop-shadow-lg";
                }

                // RESTART LOGIC
                const isHost = data.hostId === currentUser.uid;
                const hostControls = document.getElementById('hostResultControls');
                const playerWaiting = document.getElementById('playerResultWaiting');

                if (isHost) {
                    hostControls.classList.remove('hidden');
                    playerWaiting.classList.add('hidden');

                    // 1. RESTART (Keep Players, Reset Game)
                    document.getElementById('btnPlayAgain').onclick = async () => {
                        // p≈ôi nov√©m slovu v≈°ichni hr√°ƒçi zaƒç√≠naj√≠ jako aktivn√≠ (bez spectator flagu)
                        const resetPlayers = data.players.map(p => ({
                            uid: p.uid,
                            name: p.name,
                            isHost: p.isHost || false
                        }));
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), {
                            status: 'LOBBY',
                            readyPlayers: [],
                            votes: {},
                            emergencyVotes: [],
                            chatMessages: [],
                            currentTurnIndex: 0,
                            turnExpiresAt: null,
                            players: resetPlayers
                        });
                    };

                    // 2. EXIT (Kill Room)
                    document.getElementById('btnExitGame').onclick = async () => {
                         if(confirm("Opravdu zru≈°it hru?")) {
                             await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId));
                             location.reload();
                         }
                    };
                } else {
                    hostControls.classList.add('hidden');
                    playerWaiting.classList.remove('hidden');
                    document.getElementById('btnPlayerExit').onclick = () => location.reload();
                }
            });
        }

        function updateCurrentView(data) {
            switch(data.status) {
                case 'LOBBY': updateLobby(data); break;
                case 'REVEAL': updateReveal(data); break;
                case 'DISCUSSION': updateDiscussion(data); break;
                case 'VOTING': updateVoting(data); break;
            }
        }
    </script>
</body>
</html>
